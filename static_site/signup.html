<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Axolotl - Sign Up</title>
    <style>
      * { box-sizing: border-box; margin: 0; padding: 0; }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        background: #f8f9fa;
        color: #111827;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 20px;
      }

      .card {
        width: 100%;
        max-width: 420px;
        background: #ffffff;
        border: 1px solid #e5e7eb;
        border-radius: 16px;
        padding: 40px 32px;
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.06);
      }

      h1 {
        font-size: 24px;
        font-weight: 700;
        margin-bottom: 8px;
        text-align: center;
      }

      .subtitle {
        font-size: 14px;
        color: #6b7280;
        text-align: center;
        margin-bottom: 28px;
        line-height: 1.5;
      }

      .form-group {
        margin-bottom: 16px;
      }

      .form-group label {
        display: block;
        font-size: 14px;
        font-weight: 500;
        color: #374151;
        margin-bottom: 6px;
      }

      .input-wrapper {
        position: relative;
      }

      .input-wrapper input {
        width: 100%;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        padding: 12px 14px;
        font-size: 14px;
        outline: none;
        transition: border-color 0.2s;
        background: #fff;
      }

      .input-wrapper input:focus {
        border-color: #111827;
        box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.08);
      }

      .input-wrapper input::placeholder {
        color: #9ca3af;
      }

      .input-wrapper.has-toggle input {
        padding-right: 44px;
      }

      .toggle-password {
        position: absolute;
        right: 12px;
        top: 50%;
        transform: translateY(-50%);
        background: none;
        border: none;
        cursor: pointer;
        padding: 4px;
        color: #9ca3af;
        display: flex;
        align-items: center;
      }

      .toggle-password:hover {
        color: #6b7280;
      }

      .toggle-password svg {
        width: 20px;
        height: 20px;
      }

      /* Password rules */
      .password-rules {
        margin-top: 8px;
      }

      .password-rules .rule {
        display: flex;
        align-items: center;
        gap: 6px;
        font-size: 12px;
        color: #9ca3af;
        margin-bottom: 4px;
        transition: color 0.2s;
      }

      .password-rules .rule.passed {
        color: #059669;
      }

      .password-rules .rule .icon {
        font-size: 14px;
        width: 16px;
        text-align: center;
      }

      /* OTP verification section (shown after signup) */
      .verify-section {
        display: none;
      }

      .otp-inputs {
        display: flex;
        gap: 8px;
        justify-content: center;
        margin-bottom: 16px;
      }

      .otp-inputs input {
        width: 44px;
        height: 48px;
        border: 1px solid #d1d5db;
        border-radius: 10px;
        text-align: center;
        font-size: 20px;
        font-weight: 600;
        outline: none;
        transition: border-color 0.2s;
      }

      .otp-inputs input:focus {
        border-color: #111827;
        box-shadow: 0 0 0 3px rgba(17, 24, 39, 0.08);
      }

      .resend-row {
        text-align: center;
        margin-bottom: 16px;
      }

      .resend-row button {
        background: none;
        border: none;
        color: #6b7280;
        font-size: 13px;
        cursor: pointer;
        text-decoration: underline;
      }

      .resend-row button:hover {
        color: #111827;
      }

      .resend-row button:disabled {
        color: #d1d5db;
        cursor: not-allowed;
        text-decoration: none;
      }

      /* Buttons */
      .btn-create {
        width: 100%;
        background: #059669;
        color: #ffffff;
        border: none;
        border-radius: 10px;
        padding: 12px 16px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
        margin-top: 8px;
      }

      .btn-create:hover {
        background: #047857;
      }

      .btn-create:disabled {
        background: #d1d5db;
        color: #9ca3af;
        cursor: not-allowed;
      }

      .btn-verify {
        width: 100%;
        background: #111827;
        color: #ffffff;
        border: none;
        border-radius: 10px;
        padding: 12px 16px;
        font-size: 15px;
        font-weight: 600;
        cursor: pointer;
        transition: background-color 0.2s;
      }

      .btn-verify:hover {
        background: #1f2937;
      }

      .btn-verify:disabled {
        background: #9ca3af;
        cursor: not-allowed;
      }

      /* Links */
      .links {
        text-align: center;
        margin-top: 20px;
        font-size: 14px;
        color: #6b7280;
      }

      .links a {
        color: #111827;
        font-weight: 600;
        text-decoration: none;
        transition: color 0.2s;
      }

      .links a:hover {
        color: #374151;
      }

      /* Error and status messages */
      .error-msg {
        background: #fef2f2;
        border: 1px solid #fecaca;
        border-radius: 8px;
        padding: 10px 14px;
        margin-bottom: 16px;
        font-size: 13px;
        color: #991b1b;
        display: none;
        text-align: center;
      }

      .status-msg {
        text-align: center;
        font-size: 13px;
        color: #6b7280;
        margin-top: 12px;
        display: none;
      }

      .spinner {
        display: inline-block;
        width: 14px;
        height: 14px;
        border: 2px solid #d1d5db;
        border-top: 2px solid #111827;
        border-radius: 50%;
        animation: spin 0.6s linear infinite;
        vertical-align: middle;
        margin-right: 6px;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body>
    <div class="card">
      <!-- Phase 1: Registration form -->
      <div id="signup-phase">
        <h1>Sign up</h1>
        <p class="subtitle">Create your account to get started</p>

        <div class="error-msg" id="error-msg"></div>

        <!-- Full Name -->
        <div class="form-group">
          <label for="fullname">Full Name</label>
          <div class="input-wrapper">
            <input id="fullname" type="text" placeholder="Jane Doe" autocomplete="name" />
          </div>
        </div>

        <!-- Email -->
        <div class="form-group">
          <label for="email">Email</label>
          <div class="input-wrapper">
            <input id="email" type="email" placeholder="you@example.com" autocomplete="email" />
          </div>
        </div>

        <!-- Password -->
        <div class="form-group">
          <label for="password">Password</label>
          <div class="input-wrapper has-toggle">
            <input id="password" type="password" placeholder="Create a strong password" autocomplete="new-password" />
            <button type="button" class="toggle-password" id="toggle-password" aria-label="Toggle password visibility">
              <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              <svg class="eye-off-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                <line x1="1" y1="1" x2="23" y2="23"/>
              </svg>
            </button>
          </div>
          <div class="password-rules" id="password-rules">
            <div class="rule" id="rule-length"><span class="icon">&#x2715;</span> At least 6 characters</div>
          </div>
        </div>

        <!-- Confirm Password -->
        <div class="form-group">
          <label for="confirm-password">Confirm password</label>
          <div class="input-wrapper has-toggle">
            <input id="confirm-password" type="password" placeholder="Re-enter your password" autocomplete="new-password" />
            <button type="button" class="toggle-password" id="toggle-confirm-password" aria-label="Toggle password visibility">
              <svg class="eye-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                <circle cx="12" cy="12" r="3"/>
              </svg>
              <svg class="eye-off-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="display:none">
                <path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/>
                <line x1="1" y1="1" x2="23" y2="23"/>
              </svg>
            </button>
          </div>
        </div>

        <button class="btn-create" id="create-btn" disabled>Create account</button>

        <div class="links">
          Already have an account? <a href="login.html" id="login-link">Log in</a>
        </div>

        <div class="status-msg" id="status-msg"></div>
      </div>

      <!-- Phase 2: Email verification -->
      <div id="verify-phase" class="verify-section">
        <h1>Verify your email</h1>
        <p class="subtitle" id="verify-subtitle">We sent a 6-digit code to your email. Enter it below.</p>

        <div class="error-msg" id="verify-error-msg"></div>

        <div class="otp-inputs" id="otp-inputs">
          <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="0" />
          <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="1" />
          <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="2" />
          <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="3" />
          <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="4" />
          <input type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="5" />
        </div>

        <div class="resend-row">
          <button id="resend-btn" disabled>Resend code (60s)</button>
        </div>

        <button class="btn-verify" id="verify-btn" disabled>Verify email</button>

        <div class="links" style="margin-top: 16px">
          <a href="#" id="back-to-signup-link">Back to signup</a>
        </div>

        <div class="status-msg" id="verify-status-msg"></div>
      </div>
    </div>

    <script>
      // ── Config ──
      var INSFORGE_BASE_URL = "https://4zxsfry3.us-west.insforge.app"

      var params = new URLSearchParams(window.location.search)
      var state = params.get("state")
      var signupEmail = ""

      // ── DOM elements (Phase 1) ──
      var fullnameInput = document.getElementById("fullname")
      var emailInput = document.getElementById("email")
      var passwordInput = document.getElementById("password")
      var confirmPasswordInput = document.getElementById("confirm-password")
      var createBtn = document.getElementById("create-btn")
      var errorMsg = document.getElementById("error-msg")
      var statusMsg = document.getElementById("status-msg")
      var loginLink = document.getElementById("login-link")
      var signupPhase = document.getElementById("signup-phase")
      var verifyPhase = document.getElementById("verify-phase")

      // ── DOM elements (Phase 2) ──
      var otpInputs = document.querySelectorAll("#otp-inputs input")
      var verifyBtn = document.getElementById("verify-btn")
      var resendBtn = document.getElementById("resend-btn")
      var verifyErrorMsg = document.getElementById("verify-error-msg")
      var verifyStatusMsg = document.getElementById("verify-status-msg")
      var verifySubtitle = document.getElementById("verify-subtitle")
      var backToSignupLink = document.getElementById("back-to-signup-link")

      // ── Utility functions ──
      function showError(msg) {
        errorMsg.textContent = msg
        errorMsg.style.display = "block"
      }

      function hideError() {
        errorMsg.style.display = "none"
      }

      function showStatus(msg) {
        statusMsg.innerHTML = '<span class="spinner"></span>' + msg
        statusMsg.style.display = "block"
      }

      function hideStatus() {
        statusMsg.style.display = "none"
      }

      function showVerifyError(msg) {
        verifyErrorMsg.textContent = msg
        verifyErrorMsg.style.display = "block"
      }

      function hideVerifyError() {
        verifyErrorMsg.style.display = "none"
      }

      function showVerifyStatus(msg) {
        verifyStatusMsg.innerHTML = '<span class="spinner"></span>' + msg
        verifyStatusMsg.style.display = "block"
      }

      function hideVerifyStatus() {
        verifyStatusMsg.style.display = "none"
      }

      // ── Navigation ──
      loginLink.addEventListener("click", function (e) {
        e.preventDefault()
        var loginUrl = state
          ? "login.html?state=" + encodeURIComponent(state)
          : "login.html"
        window.location.href = loginUrl
      })

      backToSignupLink.addEventListener("click", function (e) {
        e.preventDefault()
        verifyPhase.style.display = "none"
        signupPhase.style.display = "block"
      })

      // ── Password toggle ──
      function setupPasswordToggle(btnId, input) {
        var btn = document.getElementById(btnId)
        btn.addEventListener("click", function () {
          var isPassword = input.type === "password"
          input.type = isPassword ? "text" : "password"
          btn.querySelector(".eye-icon").style.display = isPassword ? "none" : "block"
          btn.querySelector(".eye-off-icon").style.display = isPassword ? "block" : "none"
        })
      }
      setupPasswordToggle("toggle-password", passwordInput)
      setupPasswordToggle("toggle-confirm-password", confirmPasswordInput)

      // ── Password strength validation (InsForge: min 6 chars) ──
      var rules = {
        length: function (pw) { return pw.length >= 6 },
      }

      passwordInput.addEventListener("input", function () {
        var pw = passwordInput.value
        Object.keys(rules).forEach(function (key) {
          var ruleEl = document.getElementById("rule-" + key)
          var passed = rules[key](pw)
          ruleEl.classList.toggle("passed", passed)
          ruleEl.querySelector(".icon").innerHTML = passed ? "&#x2713;" : "&#x2715;"
        })
        updateCreateButton()
      })

      confirmPasswordInput.addEventListener("input", updateCreateButton)
      fullnameInput.addEventListener("input", updateCreateButton)
      emailInput.addEventListener("input", updateCreateButton)

      function allPasswordRulesPassed() {
        var pw = passwordInput.value
        return Object.keys(rules).every(function (key) { return rules[key](pw) })
      }

      function updateCreateButton() {
        var pw = passwordInput.value
        var confirmPw = confirmPasswordInput.value
        var name = fullnameInput.value.trim()
        var email = emailInput.value.trim()

        var valid =
          name.length > 0 &&
          email.length > 0 &&
          allPasswordRulesPassed() &&
          pw === confirmPw &&
          confirmPw.length > 0

        createBtn.disabled = !valid
      }

      // ── OTP input handling (6 digits) ──
      otpInputs.forEach(function (input, index) {
        input.addEventListener("input", function (e) {
          var value = e.target.value
          if (!/^\d*$/.test(value)) {
            e.target.value = ""
            return
          }
          if (value && index < 5) {
            otpInputs[index + 1].focus()
          }
          updateVerifyButton()
        })

        input.addEventListener("keydown", function (e) {
          if (e.key === "Backspace" && !e.target.value && index > 0) {
            otpInputs[index - 1].focus()
          }
        })

        input.addEventListener("paste", function (e) {
          e.preventDefault()
          var pastedData = e.clipboardData.getData("text").replace(/\D/g, "").slice(0, 6)
          pastedData.split("").forEach(function (char, i) {
            if (otpInputs[i]) {
              otpInputs[i].value = char
            }
          })
          var focusIndex = Math.min(pastedData.length, 5)
          otpInputs[focusIndex].focus()
          updateVerifyButton()
        })
      })

      function getOtpCode() {
        return Array.from(otpInputs).map(function (i) { return i.value }).join("")
      }

      function updateVerifyButton() {
        verifyBtn.disabled = getOtpCode().length !== 6
      }

      // ── Countdown for resend ──
      var countdownTimer = null

      function startCountdown(seconds) {
        var remaining = seconds
        resendBtn.disabled = true
        resendBtn.textContent = "Resend code (" + remaining + "s)"

        countdownTimer = setInterval(function () {
          remaining--
          if (remaining <= 0) {
            clearInterval(countdownTimer)
            resendBtn.disabled = false
            resendBtn.textContent = "Resend code"
          } else {
            resendBtn.textContent = "Resend code (" + remaining + "s)"
          }
        }, 1000)
      }

      // ── Create account ──
      createBtn.addEventListener("click", createAccount)

      function createAccount() {
        var email = emailInput.value.trim()
        var password = passwordInput.value
        var confirmPw = confirmPasswordInput.value
        var fullName = fullnameInput.value.trim()

        if (password !== confirmPw) {
          showError("Passwords do not match.")
          return
        }

        hideError()
        createBtn.disabled = true
        showStatus("Creating your account...")

        fetch(INSFORGE_BASE_URL + "/api/auth/users?client_type=desktop", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: email, password: password, name: fullName }),
        })
          .then(function (res) {
            return res.json().then(function (data) { return { ok: res.ok, status: res.status, data: data } })
          })
          .then(function (result) {
            hideStatus()

            if (!result.ok) {
              createBtn.disabled = false
              showError(result.data.message || "Failed to create account.")
              return
            }

            signupEmail = email

            if (result.data.requireEmailVerification) {
              // Show verification phase
              verifySubtitle.textContent = "We sent a 6-digit code to " + email + ". Enter it below."
              signupPhase.style.display = "none"
              verifyPhase.style.display = "block"
              otpInputs[0].focus()
              startCountdown(60)
            } else {
              // No verification needed, redirect to login
              var loginUrl = state
                ? "login.html?state=" + encodeURIComponent(state) + "&registered=true"
                : "login.html?registered=true"
              window.location.href = loginUrl
            }
          })
          .catch(function (err) {
            hideStatus()
            createBtn.disabled = false
            showError(err.message || "Failed to create account.")
          })
      }

      // ── Resend verification code ──
      resendBtn.addEventListener("click", function () {
        if (!signupEmail) return
        hideVerifyError()
        resendBtn.disabled = true

        fetch(INSFORGE_BASE_URL + "/api/auth/email/send-verification", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: signupEmail }),
        })
          .then(function (res) { return res.json() })
          .then(function () {
            startCountdown(60)
          })
          .catch(function (err) {
            resendBtn.disabled = false
            showVerifyError(err.message || "Failed to resend code.")
          })
      })

      // ── Verify email ──
      verifyBtn.addEventListener("click", verifyEmail)

      function verifyEmail() {
        var otpCode = getOtpCode()
        if (otpCode.length !== 6) return

        hideVerifyError()
        verifyBtn.disabled = true
        showVerifyStatus("Verifying your email...")

        fetch(INSFORGE_BASE_URL + "/api/auth/email/verify?client_type=desktop", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email: signupEmail, otp: otpCode }),
        })
          .then(function (res) {
            return res.json().then(function (data) { return { ok: res.ok, data: data } })
          })
          .then(function (result) {
            hideVerifyStatus()

            if (!result.ok) {
              verifyBtn.disabled = false
              showVerifyError(result.data.message || "Invalid verification code.")
              return
            }

            // Verification successful — redirect to login
            var loginUrl = state
              ? "login.html?state=" + encodeURIComponent(state) + "&registered=true"
              : "login.html?registered=true"
            window.location.href = loginUrl
          })
          .catch(function (err) {
            hideVerifyStatus()
            verifyBtn.disabled = false
            showVerifyError(err.message || "Failed to verify email.")
          })
      }
    </script>
  </body>
</html>
